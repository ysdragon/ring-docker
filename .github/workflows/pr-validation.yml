name: PR Validation

on:
  pull_request:
    branches: [master]
    paths:
      - 'Dockerfile*'
      - 'entrypoint.sh'
      - 'patches/**'
      - '.github/workflows/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  lint:
    name: Lint Dockerfiles and Scripts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Run Hadolint on Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          failure-threshold: warning
      
      - name: Run Hadolint on Dockerfile.light
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile.light
          failure-threshold: warning
      
      - name: Run Hadolint on Dockerfile.nightly
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile.nightly
          failure-threshold: warning
      
      - name: Run Hadolint on Dockerfile.nightly.light
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile.nightly.light
          failure-threshold: warning
      
      - name: Run Shellcheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          severity: warning
  
  build-test:
    name: Test Build - ${{ matrix.variant }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: light
            dockerfile: Dockerfile.light
          - variant: full
            dockerfile: Dockerfile
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build ${{ matrix.variant }} image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64
          push: false
          tags: ring:pr-test-${{ matrix.variant }}
          cache-from: type=gha,scope=pr-${{ matrix.variant }}
          cache-to: type=gha,mode=max,scope=pr-${{ matrix.variant }}
          load: true
      
      - name: Create test script
        run: |
          mkdir -p test-scripts
          echo 'see "Hello from Ring!" + nl' > test-scripts/hello.ring
          echo 'see "Version test passed" + nl' > test-scripts/version.ring
      
      - name: Test basic Ring execution
        run: |
          docker run --rm \
            -v $(pwd)/test-scripts:/app \
            -e RING_FILE=hello.ring \
            ring:pr-test-${{ matrix.variant }}
      
      - name: Test Ring version command
        run: |
          docker run --rm ring:pr-test-${{ matrix.variant }} ring -v
      
      - name: Test ring2exe (full variant only)
        if: matrix.variant == 'full'
        run: |
          docker run --rm \
            -v $(pwd)/test-scripts:/app \
            -e RING_FILE=hello.ring \
            -e RING_OUTPUT_EXE=true \
            ring:pr-test-${{ matrix.variant }}
          
          # Check if executable was created
          if [ -f test-scripts/hello ]; then
            echo "✓ Executable created successfully"
          else
            echo "✗ Executable not created"
            exit 1
          fi
  
  summary:
    name: PR Validation Summary
    runs-on: ubuntu-latest
    needs: [lint, build-test]
    if: always()
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || [ "${{ needs.build-test.result }}" != "success" ]; then
            echo "::error::PR validation failed. Please fix the issues above."
            exit 1
          fi
          echo "✓ All PR validation checks passed!"
      
      - name: Comment on PR
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ❌ PR Validation Failed
            
            Some validation checks did not pass. Please review the workflow logs and address the issues.
            
            **Failed Jobs:**
            - Lint: ${{ needs.lint.result }}
            - Build Test: ${{ needs.build-test.result }}
            
            [View Workflow Run](${context.payload.pull_request.html_url}/checks)`;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });