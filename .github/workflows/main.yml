name: Ring Docker CI

on:
  push:
    branches: [ "master" ]
    paths-ignore:
    - '**.md'
  release:
    types: [ published ]
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      force_nightly:
        description: 'Force nightly build regardless of schedule'
        type: boolean
        default: false

permissions:
  contents: read
  packages: write
  id-token: write

env:
  REGISTRIES: |
    quay.io/ydrag0n/ring
    ghcr.io/ysdragon/ring
    ${{ secrets.DOCKER_HUB_USERNAME }}/ring

jobs:
  setup:
    name: Setup Build Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      is_nightly: ${{ steps.matrix.outputs.is_nightly }}
      tags_full: ${{ steps.matrix.outputs.tags_full }}
      tags_light: ${{ steps.matrix.outputs.tags_light }}
      dockerfile_full: ${{ steps.matrix.outputs.dockerfile_full }}
    steps:
    - name: Setup build matrix
      id: matrix
      run: |
        IS_NIGHTLY="false"
        if [[ "${{ github.event_name }}" == "schedule" ]] || [[ "${{ github.event.inputs.force_nightly }}" == "true" ]]; then
          IS_NIGHTLY="true"
        fi
        
        echo "is_nightly=$IS_NIGHTLY" >> $GITHUB_OUTPUT
        
        if [[ "$IS_NIGHTLY" == "true" ]]; then
          TAGS_FULL="nightly,nightly-full"
          TAGS_LIGHT="nightly-light"
          DOCKER_FULL="Dockerfile.nightly"
          # Nightly builds - all variants
          MATRIX='{"include":[{"variant":"full","dockerfile":"Dockerfile.nightly","platforms":"linux/amd64,linux/arm64","use_matrix_build":true,"tags_suffix":"nightly,nightly-full"},{"variant":"light","dockerfile":"Dockerfile.nightly.light","platforms":"linux/amd64,linux/arm64,linux/riscv64","use_matrix_build":false,"tags_suffix":"nightly-light"}]}'
        else
          TAGS_FULL="latest,full"
          TAGS_LIGHT="light"
          DOCKER_FULL="Dockerfile"
          # Release builds - all variants
          MATRIX='{"include":[{"variant":"full","dockerfile":"Dockerfile","platforms":"linux/amd64,linux/arm64","use_matrix_build":true,"tags_suffix":"latest,full"},{"variant":"light","dockerfile":"Dockerfile.light","platforms":"linux/amd64,linux/arm64,linux/riscv64","use_matrix_build":false,"tags_suffix":"light"}]}'
        fi
        
        echo "tags_full=$TAGS_FULL" >> $GITHUB_OUTPUT
        echo "tags_light=$TAGS_LIGHT" >> $GITHUB_OUTPUT
        echo "dockerfile_full=$DOCKER_FULL" >> $GITHUB_OUTPUT
        echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  build:
    name: Build ${{ matrix.variant }} (${{ matrix.use_matrix_build && 'Multi-arch' || 'Single' }})
    runs-on: ubuntu-latest
    needs: [setup]
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up QEMU
      if: matrix.use_matrix_build == false
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to registries
      if: github.event_name != 'pull_request'
      uses: ./.github/actions/registry-login
      with:
        docker_hub_username: ${{ secrets.DOCKER_HUB_USERNAME }}
        docker_hub_token: ${{ secrets.DOCKER_HUB_TOKEN }}
        github_token: ${{ secrets.GITHUB_TOKEN }}
        quay_username: ${{ secrets.QUAY_USERNAME }}
        quay_robot_token: ${{ secrets.QUAY_ROBOT_TOKEN }}

    - name: Extract Docker metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRIES }}
        tags: |
          type=raw,value=${{ matrix.tags_suffix }},enable={{is_default_branch}}

    - name: Build and push (Single build)
      if: matrix.use_matrix_build == false
      id: build-single
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ${{ matrix.dockerfile }}
        platforms: ${{ matrix.platforms }}
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
  build-matrix:
    name: Build Matrix ${{ matrix.variant }} - ${{ matrix.arch }}
    runs-on: ${{ matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-24.04' }}
    needs: [setup]
    if: needs.setup.outputs.is_nightly == 'true' || github.event_name == 'push' || github.event_name == 'release'
    strategy:
      fail-fast: false
      matrix:
        include:
        - variant: full
          arch: amd64
        - variant: full
          arch: arm64
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to registries
      if: github.event_name != 'pull_request'
      uses: ./.github/actions/registry-login
      with:
        docker_hub_username: ${{ secrets.DOCKER_HUB_USERNAME }}
        docker_hub_token: ${{ secrets.DOCKER_HUB_TOKEN }}
        github_token: ${{ secrets.GITHUB_TOKEN }}
        quay_username: ${{ secrets.QUAY_USERNAME }}
        quay_robot_token: ${{ secrets.QUAY_ROBOT_TOKEN }}

    - name: Build and push arch-specific image
      id: build-and-push
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ${{ needs.setup.outputs.dockerfile_full }}
        platforms: linux/${{ matrix.arch }}
        push: ${{ github.event_name != 'pull_request' }}
        tags: |
          quay.io/ydrag0n/ring:${{ github.sha }}-${{ matrix.arch }}
          ghcr.io/ysdragon/ring:${{ github.sha }}-${{ matrix.arch }}
          ${{ secrets.DOCKER_HUB_USERNAME }}/ring:${{ github.sha }}-${{ matrix.arch }}
        provenance: false
        cache-from: type=gha,scope=${{ matrix.arch }}
        cache-to: type=gha,mode=max,scope=${{ matrix.arch }}

  manifest:
    name: Create Multi-arch Manifests
    runs-on: ubuntu-latest
    needs: [setup, build-matrix]
    if: always() && needs.build-matrix.result == 'success' && github.event_name != 'pull_request'
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Login to registries
      uses: ./.github/actions/registry-login
      with:
        docker_hub_username: ${{ secrets.DOCKER_HUB_USERNAME }}
        docker_hub_token: ${{ secrets.DOCKER_HUB_TOKEN }}
        github_token: ${{ secrets.GITHUB_TOKEN }}
        quay_username: ${{ secrets.QUAY_USERNAME }}
        quay_robot_token: ${{ secrets.QUAY_ROBOT_TOKEN }}

    - name: Create and push manifests
      run: |
        TAGS="${{ needs.setup.outputs.tags_full }}"
        
        # Parse REGISTRIES env var into array; add '|| true' to prevent exit on EOF
        IFS=$'\n' read -d '' -r -a REGISTRY_LIST <<< "${{ env.REGISTRIES }}" || true
        
        for tag in ${TAGS//,/ }; do
          echo "Creating manifest for tag: $tag"
          
          for registry_image in "${REGISTRY_LIST[@]}"; do
            # Trim whitespace if any
            registry_image=$(echo "$registry_image" | xargs)
            [ -z "$registry_image" ] && continue
            
            echo "Processing $registry_image:$tag"
            docker manifest create "$registry_image:$tag" \
              "$registry_image:${{ github.sha }}-amd64" \
              "$registry_image:${{ github.sha }}-arm64"
            docker manifest push "$registry_image:$tag"
          done
        done

  cleanup:
    name: Cleanup Intermediate Images
    runs-on: ubuntu-latest
    needs: [setup, build, build-matrix, manifest]
    if: always() && needs.build-matrix.result == 'success' && github.event_name != 'pull_request'
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Install Crane
      uses: iarekylew00t/crane-installer@v3

    - name: Login to registries
      uses: ./.github/actions/registry-login
      with:
        docker_hub_username: ${{ secrets.DOCKER_HUB_USERNAME }}
        docker_hub_token: ${{ secrets.DOCKER_HUB_TOKEN }}
        github_token: ${{ secrets.GITHUB_TOKEN }}
        quay_username: ${{ secrets.QUAY_USERNAME }}
        quay_robot_token: ${{ secrets.QUAY_ROBOT_TOKEN }}

    - name: Delete intermediate SHA-tagged images
      run: |
        echo "Cleaning up intermediate images with SHA: ${{ github.sha }}"
        
        # Parse REGISTRIES env var into array; add '|| true' to prevent exit on EOF
        IFS=$'\n' read -d '' -r -a REGISTRIES <<< "${{ env.REGISTRIES }}" || true
        
        ARCHITECTURES=("amd64" "arm64")
        CLEANUP_ERRORS=0
        
        for arch in "${ARCHITECTURES[@]}"; do
          for registry in "${REGISTRIES[@]}"; do
            # Trim whitespace
            registry=$(echo "$registry" | xargs)
            [ -z "$registry" ] && continue

            image_tag="$registry:${{ github.sha }}-$arch"
            echo "Attempting to delete: $image_tag"
            
            if crane delete "$image_tag" 2>/dev/null; then
              echo "✓ Successfully deleted: $image_tag"
            else
              echo "⚠ Failed to delete or not found: $image_tag"
              CLEANUP_ERRORS=$((CLEANUP_ERRORS + 1))
            fi
          done
        done
        
        echo "Cleanup completed with $CLEANUP_ERRORS errors."
        if [ $CLEANUP_ERRORS -gt 0 ]; then
          echo "Some intermediate images could not be cleaned up, but this is not critical."
        fi