name: Ring Docker CI

on:
  push:
    branches: [ "master" ]
    paths-ignore: [ '**.md' ]
  release:
    types: [ published ]
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      force_nightly:
        description: 'Force nightly build regardless of schedule'
        type: boolean
        default: false

permissions:
  contents: read
  packages: write
  id-token: write

env:
  REGISTRIES: |
    quay.io/ydrag0n/ring
    ghcr.io/ysdragon/ring
    ${{ secrets.DOCKER_HUB_USERNAME }}/ring

jobs:
  config:
    name: Configuration
    runs-on: ubuntu-latest
    outputs:
      is_nightly: ${{ steps.vars.outputs.is_nightly }}
      tags: ${{ steps.vars.outputs.tags }}
      tags_light: ${{ steps.vars.outputs.tags_light }}
      dockerfile_full: ${{ steps.vars.outputs.dockerfile_full }}
      dockerfile_light: ${{ steps.vars.outputs.dockerfile_light }}
    steps:
      - name: Determine Build Variables
        id: vars
        run: |
          # Check for Nightly triggers
          if [[ "${{ github.event_name }}" == "schedule" ]] || [[ "${{ inputs.force_nightly }}" == "true" ]]; then
            IS_NIGHTLY="true"
            echo "mode=Nightly" >> $GITHUB_STEP_SUMMARY
            
            echo "tags=nightly,nightly-full" >> $GITHUB_OUTPUT
            echo "tags_light=nightly-light" >> $GITHUB_OUTPUT
            echo "dockerfile_full=Dockerfile.nightly" >> $GITHUB_OUTPUT
            echo "dockerfile_light=Dockerfile.nightly.light" >> $GITHUB_OUTPUT
          else
            IS_NIGHTLY="false"
            echo "mode=Release/Push" >> $GITHUB_STEP_SUMMARY
            
            echo "tags=latest,full" >> $GITHUB_OUTPUT
            echo "tags_light=light" >> $GITHUB_OUTPUT
            echo "dockerfile_full=Dockerfile" >> $GITHUB_OUTPUT
            echo "dockerfile_light=Dockerfile.light" >> $GITHUB_OUTPUT
          fi
          echo "is_nightly=$IS_NIGHTLY" >> $GITHUB_OUTPUT

  build-light:
    name: Build Light (QEMU)
    runs-on: ubuntu-latest
    needs: [config]
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: false
          
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to registries
        if: github.event_name != 'pull_request'
        uses: ./.github/actions/registry-login
        with:
          docker_hub_username: ${{ secrets.DOCKER_HUB_USERNAME }}
          docker_hub_token: ${{ secrets.DOCKER_HUB_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          quay_username: ${{ secrets.QUAY_USERNAME }}
          quay_robot_token: ${{ secrets.QUAY_ROBOT_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRIES }}
          tags: |
            type=raw,value=${{ needs.config.outputs.tags_light }},enable={{is_default_branch}}

      - name: Build and Push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ needs.config.outputs.dockerfile_light }}
          platforms: linux/amd64,linux/arm64,linux/riscv64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=light
          cache-to: type=gha,mode=max,scope=light

  build-full:
    name: Build Full (${{ matrix.arch }})
    needs: [config]
    runs-on: ${{ matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-24.04' }}
    if: needs.config.outputs.is_nightly == 'true' || github.event_name == 'push' || github.event_name == 'release'
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to registries
        if: github.event_name != 'pull_request'
        uses: ./.github/actions/registry-login
        with:
          docker_hub_username: ${{ secrets.DOCKER_HUB_USERNAME }}
          docker_hub_token: ${{ secrets.DOCKER_HUB_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          quay_username: ${{ secrets.QUAY_USERNAME }}
          quay_robot_token: ${{ secrets.QUAY_ROBOT_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push (Arch Specific)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ needs.config.outputs.dockerfile_full }}
          platforms: linux/${{ matrix.arch }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            quay.io/ydrag0n/ring:${{ github.sha }}-${{ matrix.arch }}
            ghcr.io/ysdragon/ring:${{ github.sha }}-${{ matrix.arch }}
            ${{ secrets.DOCKER_HUB_USERNAME }}/ring:${{ github.sha }}-${{ matrix.arch }}
          provenance: false
          cache-from: type=gha,scope=full-${{ matrix.arch }}
          cache-to: type=gha,mode=max,scope=full-${{ matrix.arch }}

  merge-full:
    name: Create Full Manifest
    runs-on: ubuntu-latest
    needs: [config, build-full]
    if: github.event_name != 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to registries
        uses: ./.github/actions/registry-login
        with:
          docker_hub_username: ${{ secrets.DOCKER_HUB_USERNAME }}
          docker_hub_token: ${{ secrets.DOCKER_HUB_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          quay_username: ${{ secrets.QUAY_USERNAME }}
          quay_robot_token: ${{ secrets.QUAY_ROBOT_TOKEN }}

      - name: Create and Push Manifests
        run: |
          TARGET_TAGS="${{ needs.config.outputs.tags }}"
          SHA="${{ github.sha }}"
          
          REPO_LIST=(${{ env.REGISTRIES }})
          
          for tag in ${TARGET_TAGS//,/ }; do
            echo "::group::Processing tag: $tag"
            
            for repo in "${REPO_LIST[@]}"; do
              echo "Creating manifest for $repo:$tag"
              
              docker manifest create "$repo:$tag" \
                "$repo:$SHA-amd64" \
                "$repo:$SHA-arm64"
                
              docker manifest push "$repo:$tag"
            done
            echo "::endgroup::"
          done

  cleanup:
    name: Cleanup Intermediate Tags
    runs-on: ubuntu-latest
    needs: [merge-full]
    if: always() && needs.merge-full.result == 'success'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Crane
        uses: iarekylew00t/crane-installer@v4

      - name: Login to registries
        uses: ./.github/actions/registry-login
        with:
          docker_hub_username: ${{ secrets.DOCKER_HUB_USERNAME }}
          docker_hub_token: ${{ secrets.DOCKER_HUB_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          quay_username: ${{ secrets.QUAY_USERNAME }}
          quay_robot_token: ${{ secrets.QUAY_ROBOT_TOKEN }}

      - name: Delete Intermediate Images
        run: |
          SHA="${{ github.sha }}"
          REPO_LIST=(${{ env.REGISTRIES }})
          ARCHS=("amd64" "arm64")
          
          for repo in "${REPO_LIST[@]}"; do
            for arch in "${ARCHS[@]}"; do
              TAG="$repo:$SHA-$arch"
              echo "Deleting $TAG..."
              if ! crane delete "$TAG" 2>/dev/null; then
                 echo "::warning::Failed to delete $TAG (might not exist or permission error)"
              fi
            done
          done